<!DOCTYPE html>
<html lang="en">

<style>
    div {
        white-space: pre-wrap;
    }

    @import url(https://fonts.googleapis.com/css?family=Open+Sans:400,700);

    * {
        margin: 0;
        padding: 0;
        border: 0;
        outline: 0;
    }

    body {
        font-family: 'Open Sans', sans-serif;
        font-size: 1em;
        font-weight: 400;
        background-color: #074f6f;
    }

    .wrapper {
        max-width: 700px;
        width: 100%;
        margin: 50px auto;
    }

    .question {
        background-color: #ecf0f1;
        padding: 20px;
        border-radius: 20px;
        margin-bottom: 2em;
    }

    .question .question-headline {
        font-weight: 700;
        border-bottom: 2px solid #ddd;
        font-size: 1.5em;
        color: #000;
    }

    .question .question-answers {
        margin-top: 1em;
        color: #222;
    }

    .question .question-answers .answer + .answer {
        margin-top: .5em;
    }

    .question .question-answers .answer input {
        display: inline-block;
        margin-right: 1em;
    }

    .question .question-answers .answer label {
        cursor: pointer;
    }

    .result {
        margin-bottom: 2em;
        font-size: 1.2em;
        background-color: #3498db;
        border-radius: 10px;
        padding: 10px 20px;
        display: none;
    }

    .btn-check {
        padding: 10px 20px;
        background-color: #2ecc71;
        color: #fff;
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        font-size: 1.5em;
    }

    .btn-check:hover {
        background-color: #0f6c36;
    }

    #timer {
        position: fixed;
        left: 0;
        top: 0;
        font-family: Arial, sans-serif;
        font-size: 20px;
        color: #d1d1d1;
        letter-spacing: -1px;
    }

    #timer span {
        font-size: 60px;
        color: #d9d9d9;
        margin: 0 3px 0 15px;
    }

    #timer span:first-child {
        margin-left: 0;
    }


</style>


<head>
    <meta charset="UTF-8">
    <title>Solve a test</title>
    <script
            src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous">

    </script>
</head>
<body>


<div id="wrapper" class="wrapper">

    <div id="timer">
        <span id="hours"></span>hours<span id="minutes"></span>minutes<span id="seconds"></span>seconds
    </div>
    <div class='result'></div>
</div>

</body>


<script>

    let questionCount = 0;
    let wrapperDiv = $('#wrapper');
    let interval;
    let $wrapper;

    let current;
    let end;

    wrapperDiv.ready(function () {
        $wrapper = $('#wrapper');
        let pathArray = window.location.pathname.split('/');
        let id = parseInt(pathArray[pathArray.length - 1]);

        $.get('/question/test?testId=' + id, function (questions) {

            questions.forEach(function (question) {
                let $questionDiv = $('<div/>').attr('class', 'question').attr('id', question.id);
                questionCount++;

                let points = question.points;


                let $questionHeadLine = $('<div/>').attr('class', 'question-headline').text(questionCount + '. ' + question.question + ' (' + points + ' points)');
                let answers = question.answerDtoList;
                let correctAnswerCount = correct_answer_count(answers);
                let $answerContainer = $('<div/>').attr('class', 'question-answers');
                answers.forEach(function (answer) {
                    let $label = $('<label/>');
                    let $answerDiv = $('<div/>').attr('class', 'answer');
                    $label.html(answer.answer);
                    if (correctAnswerCount === 1) {
                        let $input = $('<input/>').attr('type', 'radio').attr('name', 'question' + questionCount).attr('answerId', answer.id);
                        $label.prepend($input);
                    } else {
                        let $input = $('<input/>').attr('type', 'checkbox').attr('answerId', answer.id);
                        $label.prepend($input);
                    }
                    $answerDiv.append($label);
                    $answerContainer.append($answerDiv);
                });
                $questionDiv.append($questionHeadLine);
                $questionDiv.append($answerContainer);
                $wrapper.append($questionDiv);
            });
            let $submit = $('<button/>').attr('class', 'btn-check').attr('onclick', 'submitTest()').html('Submit').attr('id', 'submitId');
            let $score = $('<button/>').attr('class', 'btn-check').attr('onclick', "location.href='http://localhost:8080/test/scorepage'").attr('value', 'Go to Score').html('Go to Score').attr('id', 'scoreId');
            $score.prop('disabled', true);
            $score.hide();
            $wrapper.append($submit);
            $wrapper.append($score);

            $.post('/test/timer/' + id, function (timerData) {

                let endTime = new Date(timerData.endTime).getTime();

                $('#timer').append($('<span/>').attr('id', 'hours')).append($('<span/>').attr('id', 'minutes')).append($('<span/>').attr('id', 'seconds'));

                let now = new Date(timerData.currentTime).getTime();

                interval = setInterval(function () {

                    let duration = endTime - now;

                    let hours = (duration > 0) ? Math.floor((duration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)) : 0;
                    let minutes = (duration > 0) ? Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60)) : 0;
                    let seconds = (duration > 0) ? Math.floor((duration % (1000 * 60)) / 1000) : 0;
                    $('#hours').text(hours);
                    $('#minutes').text(minutes);
                    $('#seconds').text(seconds);
                    now = now + 1000;


                    if (duration < 1000) {
                        current = timerData.currentTime;
                        end = now;
                        submitTest();
                    }

                }, 1000);


            });


        });
    });


    function correct_answer_count(array) {
        let count = 0;
        array.forEach(function (element) {
            if (element.correct)
                count++;
        });
        return count;
    }

    function submitTest() {
        $wrapper.css("pointer-events", "none");
        $('.btn-check').css("pointer-events", "auto");
        clearInterval(interval);
        let rawData = $('.question').map(function () {
            let questionId = parseInt($(this).attr('id'));

            // $('#submission').attr('action','http://localhost:8080/').attr('method','POST');
            let answers = $(this).find('[answerId]').map(function () {
                if ($(this).is(':checked')) {
                    return parseInt($(this).attr('answerId'));
                }
            }).toArray();

            return {
                questionId: questionId,
                chosenAnswerList: answers
            }
        }).toArray();
        let data = JSON.stringify(rawData);
        console.log(data);


        let timeData = JSON.stringify({
            currentTime: parseInt(current),
            endTime: parseInt(end)

        });
        console.log(timeData);

        $.ajax({
            type: "GET",
            data: timeData,
            url: "/test/scorepage",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: (function () {

            })
        });


        $.ajax({
            type: "POST",
            data: data,
            url: "/test/process",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: (function () {

            })
        });


        $('#submitId').remove();
        $('#scoreId').prop('disabled', false).show();


    }


</script>


</html>