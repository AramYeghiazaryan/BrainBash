<!DOCTYPE html>

<style>
    .txtAnswer {
        position: relative;
        overflow: hidden;
        left: 0;
    }

    .txtAnswer label {
        position: absolute;
        left: 5px;
    }

</style>

<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add a Question</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script
            src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>
</head>
<body>
<form>
<div class="navigation">
    <label>
        Category : <select id="categories" onchange="loadSubCategoriesDropDown()"></select>
    </label>
</div>

<br/>
<label>
    Question body
    </br>
    <textarea rows="10" cols="50" id="questionText" type="text">
    </textarea>
</label>
<br/>
<label>
    Level : <select id="level">
    <option name="beginner">beginner</option>
    <option name="intermediate">intermediate</option>
    <option name="advanced">advanced</option>
</select>
</label>
<br/>
<label>
    Points <input name="points" type="text" id="points">
</label>
<br/>

<br/>

<div id="answerBlock">
    <button type="button" id="btnAddAnswer" class="txtAnswer" onclick="addAnswer()">Add answer</button>
    <button type="button" id="btnRemoveAnswer" class="txtAnswer" onclick="removeAnswer()">Remove answer</button>
</div>

<button type="submit" value="button" onclick="createQuestion()">Create</button>


</form>
<br/>
</body>

<script>
    let answerCount = 0;

    function addAnswer() {

        answerCount++;

        let $answerBlock = $('#answerBlock');
        let $answerSet = $('<div/>').attr('class', 'answerClass');
        let answerText = $('<textarea />').attr('row', '5').attr('column', '25').attr('type', 'text').attr('id', 'answerText');
        let answerDescription = $('<textarea />').attr('row', '5').attr('column', '25').attr('id', 'answerDescription');
        let isCorrect = $('<input/>').attr('type', 'checkbox').attr('id', 'isCorrect');
        let label = $('<label/>').html('Answer #' + answerCount + ': ');
        let descriptionLabel = $('<label/>').html(' Description: ');
        let isCorrectLabel = $('<label/>').html(' Is Correct ');

        $answerBlock.append($answerSet);
        $answerSet.append(answerText).append(descriptionLabel).append(answerDescription).append(isCorrect).append(label);
        $answerSet.prepend(label);
        $answerSet.append(isCorrectLabel);


    }

    function removeAnswer() {
        if (answerCount >= 1) {
            let divToRemove = $('.answerClass').last();
            divToRemove.remove();
            answerCount--;
        }
    }


    function createQuestion() {
        let topicId = parseInt($('#topics').val());
        let questionText = $('#questionText').val();
        let level = $('#level').val();
        let points = parseInt($('#points').val());


        let answerData = $('#answerBlock').find('.answerClass').map(function () {

            let answerText = $(this).find('#answerText').val();
            let answerDescription = $(this).find('#answerDescription').val();
            let isCorrect = $(this).find('#isCorrect').is(":checked");

            return {
                answer: answerText,
                description: answerDescription,
                correct: isCorrect
            }
        }).toArray();
        console.log(answerData);

        let question = JSON.stringify({
            topicId: topicId,
            question: questionText,
            level: level,
            points: points,
            answerDtoList: answerData
        });
        console.log(question);

        $.ajax({
            type: "POST",
            data: question,
            url: "/question/add",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: (function (result) {
                console.log(result);
                location.href = 'http://localhost:8080/question/add';
            })
        });
    }


    let $selectDropDown = $('#categories');

    $.get('/category', function (categories) {
        loadCategories(categories);
    });

    function loadCategories(categories) {
        loadSelectOptionsCategories($selectDropDown, categories);
    }

    function loadSelectOptionsCategories($select, categories) {
        categories.forEach(function (category) {
            let $option = $('<option/>', {
                value: category.id,
                text: category.type
            });
            $select.append($option);
        });
        $select.val([]);
    }

    function loadSubCategoriesDropDown() {
        $('#subCategoryDiv').empty();
        let categoryId = $('#categories').val();
        $.get('/subcategory/filter?categoryId=' + categoryId, function (subCategories) {

            let $subCategoryDiv = $('<div/>').attr('id', 'subCategoryDiv');

            let $subCategorySelector = $('<select/>').attr('id', 'subCategories');

            subCategories.forEach(function (subCategory) {
                let $option = $('<option/>', {
                    value: subCategory.id,
                    text: subCategory.typeName
                });
                $subCategorySelector.append($option);
            });
            let subLabel = $('<label/>').html(' SubCategory: ');
            subLabel.append($subCategorySelector);
            $('.navigation').append($subCategoryDiv);
            $('#subCategoryDiv').append($('<br/>')).append(subLabel);
            $subCategorySelector.val([]);
            $subCategorySelector.attr('onchange', 'loadTopicsDropDown()');
        });
    }

    function loadTopicsDropDown() {
        $('#topicDiv').empty();
        let subCategoryId = $('#subCategories').val();
        $.get('/topic?subCategoryId=' + subCategoryId, function (topics) {
            let $topicDiv = $('<div/>').attr('id', 'topicDiv');
            let $topicSelector = $('<select/>').attr('id', 'topics');

            topics.forEach(function (topic) {
                let $option = $('<option/>', {
                    value: topic.id,
                    text: topic.topicName
                });
                $topicSelector.append($option);
            });

            let topicLabel = $('<label/>').html(' Topic: ');
            topicLabel.append($topicSelector);
            $('#subCategoryDiv').append($topicDiv);
            $('#topicDiv').append($('<br/>')).append(topicLabel);
        });
    }


</script>

</html>